name: Nightly Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    if: github.repository == 'libcord-tech/gauntlet'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Zip build directory
        run: zip -r gauntlet-nightly.zip build/

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: nightly-${{ github.sha }}
          release_name: Gauntlet Nightly ${{ github.sha }}
          draft: false
          prerelease: true
          body: |
            ⚠️ Gauntlet Nightly - Unstable Release ⚠️

            This is a nightly build generated from the latest code. It is provided for users who are fine with bugs and want to have the latest features. It may contain bugs and incomplete features. Use it at your own risk.

            For the latest stable release, please look at the [Releases](https://github.com/libcord-tech/gauntlet/releases/latest) page.

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./gauntlet-nightly.zip
          asset_name: gauntlet-nightly.zip
          asset_content_type: application/zip
